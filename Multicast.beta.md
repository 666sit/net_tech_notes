# 组播（Multicast）
## 1. 概述
该协议数据层面是基于UDP协议。
### 1.1 组播概念模型
组播服务体系结构中，有3个部分：源端、组播分发树以及接收端。

![multicast_model](https://github.com/Minions1128/net_tech_notes/blob/master/img/multicast_model.jpg "multicast_model")
* 源端，发送组播流量的组播应用软件服务；
* 组播分发树，路由器使用动态路由协议转发组播报文，例如PIM, DVMRP, MOSPF为IGP组播协议；MBGP、MSDP为EGP组播协议；
* 接收端，最后一条路由器与终端之间，使用IGMP协议来交互是否接受组播流量。
### 1.2 组播地址
#### 1.2.1 组播IP地址
组播地址是保留的D类地址，即224.0.0.0 – 239.255.255.255，并且没有子网掩码的概念。分为以下几大类：
1. 保留链路本地地址（Link Local Address）：范围是224.0.0.0 – 224.0.0.255。其中224.0.0.1为组播组内，所有成员监听的地址；224.0.0.2为所有路由器监听的地址；224.0.0.9为RIPv2监听的地址；224.0.0.10为EIGRP监听的地址；224.0.0.6与224.0.0.5为OSPF监听的地址；224.0.0.13为PIM发送Hello的地址。
2. 全局地址（Globally Scoped Address），即所谓的公网组播地址：范围是224.0.1.0 – 238.255.255.255。其中232.0.0.0 – 232.255.255.255为指定源组播（SSM, Source Specific Multicast）；GLOP地址，233.0.0.0 – 233.255.255.255，AS号与组播地址关联。
3. 限制范围地址（Limited Scoped Address），即私网组播地址：范围是239.0.0.0 – 239.255.255.255。
#### 1.2.2 组播MAC地址
IP地址与MAC地址的映射方式：MAC地址的前25 bit强制规定为01.00.5e，后23 bit与IP组播地址的后23 bit相同：
 
这种映射会出现多个IP地址映射到一个MAC地址的情况，所以要避免这种情况。






ASM, Any Source Multicast，任意源组播，路由器转发报文不关心是谁发送的报文，只负责转发报文。
SSM, Source Specific Multicast，指定源组播，路由器只对某个路由器转发组播报文，这样底层客户端可以知道源地址。


2. IGMP
Internet Group Management Protocol，封装的IP报文之内，协议号为2，至今有三个版本，使用者最后一跳到终端。
2.1 IGMPv1
2.1.1 报文类型
该协议有2类报文——成员查询和成员通告报文：
 
1.  Query报文，报文源地址为路由器地址，目的地址为224.0.0.1，组地址：0.0.0.0；
2.  Report报文，某终端想加入某个组播组（例如224.1.1.1组），它会发送源地址为PC的IP地址、目的地址为224.1.1.1，组地址为224.1.1.1的报文。该报文的目的地址为224.1.1.1有两个目的：A，告知最后一跳路由器该网络有PC加入该组播组；B，告知其他终端不要再发送其他通告报文。
2.1.2 通信过程
1. Query报文的发送
最后一跳路由器会以周期为60 – 120s发送查询报文，查询是否有终端想加入某个组。如果有多台路由器作为查询者，会由PIM选举出DR，作为查询者发送Query。
2. Report报文的发送
终端想加入某个组播组，可以发送该报文，该报文可以作为作为Query报文的Ack报文，也可以主动向最后一跳路由器发送。
3. 流量转发
最后一跳路由器收到Report报文之后，会建立的相应表项，同时也会保持60s一次的查询报文的发送。终端收到查询报文之后，也会回复Report报文。
4. 离组
终端离开组播组的过程成为静悄悄地离组，不会通知最后一跳路由器。路由器新建一个表项之后，会建立一个180s的Holdtime计时器，在计时器到期之前，没有收到任何Report报文，就会停止转发该类报文。这为IGMPv1的硬伤。
2.2 IGMPv2
2.2.1 报文类型
相比IGMPv1，新定义了2个报文：指定组查询（Group-Specific Query）和离组消息（Leave Group Message）。
 
 
3. 离组报文，源地址为本机地址，目的地址为224.0.0.2，组播组地址为想要离开的组，即224.1.1.1。
4. 指定组查询报文，源地址为本地地址，目的地址和组地址为224.1.1.1。
2.2.2 通信过程
1. 选举查询者
IGMPv2定义了查询者机制，多个查询者需要选出接口IP地址最小的作为查询者，由他来周期性的发送查询报文。选举报文由第一次的查询报文来决定。如果120s之内没有收到查询报文，会重新根据查询者选举机制来确定新的查询者。
多个最后一跳路由器发送查询报文，既可以选举出查询者，又可以通告终端是否要加入组播组。
2. 加组
当有终端想要加入组播组时，发送Report报文。该报文也可以抑制其他终端发送Report报文。
3. 转发流量
4. 离组
当某个终端想要离开组播组时，要发送离组报文。查询者收到离组报文之后，会将超时计时器由180s改为2s，然后发送指定组查询报文，如果在超时时间内没有收到应答，查询者认为该组中没有报文，会停止发送组播组消息。
*2.3 IGMPv3

 

2.4 配置命令
ip multicast-routing #开启组播路由
ip pim sparse-mode #端口开启PIM Sparse-mode
ip igmp join-group 224.1.1.1 #端口加入224.1.1.1组播组
ip igmp version 3 #端口启用IGMPv3
2.5 交换机对组播流量的优化
2.5.1 CGMP
该协议运行在交换机与路由器之间，实现组播流量不会在整个广播域内泛洪。
终端要加入某组播组，会发送Report报文，该报文的2层封装的源MAC地址为本地MAC地址，称为USA，目的MAC地址为224.1.1.1对用的MAC地址，成为GDA。路由器收到该报文之后，将USA和GDA信息生成CGMP通告报文发送给交换机，交换机会将该报文中的信息存入相应的SGMP表项。交换机等收到该数据报文之后，就不会向其他端口转发，复制若干份，只发送给相应端口。由于MAC地址与IP地址的映射为模糊映射，所以可能会造成少发。
2.5.2 IGMP snooping
交换机开启该机制，收到终端发送的Report报文会拆到3层报文，查看其IP地址，然后将组播组地址，然后再与端口相对应。避免了模糊映射，缺点是需要拆包到3层。
IGMP snooping配置命令：
ip igmp snooping #全局开启IGMP Snooping
show igmp snooping #查看IGMP Snooping信息
*2.5.3 IGMP Proxy
3. RPF校验
3.1 校验目的
防止重复报文产生，解决环路问题。
3.2 校验过程
当路由器收到了一个组播组信源发送的组播流量，提取其源IP地址，在本地路由条目中查找：
1. 如果路由表中没有去往源IP地址的路由条目，丢弃该报文；
2. 如果路由表中有去往源IP地址的路由条目，转发接口与收到该组播信源报文的接口不为同一接口，则丢弃该报文；
3. 如果路由表中有去往源IP地址的路由条目，并且转发接口与收到该组播信源报文的接口为同一接口，则转发报文。
3.3 负载均衡
在路由负载均衡的条件下，出站接口的IP地址越大，越有可能作为RPF接口。
如果信源服务器有两个，我们任然需要做负载均衡，可以手动修改其RPF接口。通过修改组播路由条目，来修改服务器的出站接口，宠儿修改RPF接口。使用命令ip mroute x.x.x.x mask interface修改出站接口，x.x.x.x为服务器IP地址，使用命令show ip mroute static查看组播静态路由。
4. PIM
PIM (Protocols Independent Multicast)使用树形结构转发流量，组播分发树的类型：Source-rooted，也称为Shortest Path Trees（SPTs）还有Shared Trees，也叫Rendezvous Point（RP，集合点）树。
这两种树对应2中协议：SPT对应Dense模式；RPT对应Sparse模式。
组播流量部署完毕之后，路由器之间会建立邻居，但是不会立即发送彼此的路由条目，而是等有组播流量产生之后，才会传递路由条目。
PIM报文封装在IP报文之内，协议号为13，通过224.0.0.13地址发送给邻居。
PIM建立邻居使用的链路有2种类型，P2P和MA，使用MA建立邻居时需要选出DR，DR的选举方式与OSPF一样。维护邻居关系的Hello报文发送时间为30s，Holdtime为3.5*30=105s。
4.1 PIM-DM
4.1.1 SPT
当启用了PIM-DM，当有流量需要转发时，会向邻居泛洪流量，通过RPF校验，确定出最短路径以及转发端口。生成（S, G）表项。
优点是路径最短，缺点是表项很多，浪费资源。
4.1.2 协议过程
整网95%的路由器都要接受组播流量，这是需要部署PIM-DM，基于推push模型。
第一跳路由器收到组播流量之后，会进行初始化泛洪，流量会通过第一跳路由器泛洪的整个网络。
优化方式，如果路由器通过IGMP可以判断出，下游没有接受组播流量，则可以发送一个剪裁消息（prune message），以阻止泛洪流量的发送。路由器收到prune消息后，接口会180s以内不会发送组播流量，180s之后，该接口会重新发送组播流量。可以理解为每3分钟的泛洪与修剪的过程。
4.1.3 配置命令
1. 部署IGP：组播域内部署单播路由收敛，第一跳路由器连接信源的端口需要加入到组播域，最后一跳路由器连接接受者的端口不一定要宣告到组播域内的单播路由内；
2. 运行PIM：第一跳路由器连接信源接口、组播域内、最后一跳路由器连接终端的接口都需要部署PIM，在全局模式启用组播：ip multicast-routing，交换机的命令是ip multicast-routing distributed，在接口模式开启pim密集模式：ip pim dense-mode；
3. 检查配置：show单播路由表，show ip pim neighbor检查pim邻居，show ip mroute查看组播路由表（表项中的路由条目会对应有端口，以及是否有剪裁），在信源ping组播地址
4.2 PIM-SM
4.2.1 RPT
RPT中，由管理员定义一个RP，第一跳路由器收到流量之后，不会发往目的地，而是现发送给RP，然后再由RP转发给接受者。生成（*，G）表项。
优点是优化部分路由，缺点是路径是最优。
4.2.2 协议过程
整网中有5%设备接受流量使用稀疏模式，他使用了拉（pull）模型，会同时使用到SPT和RPT。
1. 当最后一跳路由器接收到IGMP Report报文后，会生成相应的表项，同时会发送（*，G）Join给RP，告知RP以及沿途路由器，本路由器有接受者。
2. RP收到（*，G）join后，RP到接受者的沿途路由器会形成RPT。
3. 信源发送组播流量，第一跳路由器将（S，G）register封装成单播包发送给RP，目的在于查询在该组播域内是否有接受者。
4. RP收到之后，会解封成组播包，以RPT发送给接受者；同时，RP会向第一跳路由器发送（S, G）join，加入到SPT中。
5. 这时，第一跳路由器会同时发送组播封装成的单播流量和组播流量给，为了防止重复报文，RP会向第一跳路由器封装成单播的形式发送（S，G）register-stop报文，目的告知第一跳路由器发送只组播报文到本地。
6. 为了优化组播流量发送的路由，收到组播流量的最后一跳路由器，如果流量超过阈值（默认为0 kbps），会向第一跳路由器发送（S，G）join，以第一跳路由器到本地的SPT。当去往RP与第一跳路由器的“岔路路由器”时，“岔路路由器”会转发最后一跳路由器的（S，G）join给第一跳路由器，同时向RP发送一个（S，G）RP置为的prune报文，告知 RP本地不接受RPT接受流量。
7. 第一跳路由器收到最后一跳路由器的（S，G）join，SPT建立完成，使用SPT转发组播流量。
4.2.3 RP的选举
选举RP有三种方式，静态RP、auto-RP以及BSR
1.  静态RP：有网络管理员手动指定。
2.  Auto-RP
该选举方式为C/S模型，C为CRP（Candidate RP），S为MA（Mapping Agency）。CRP周期性地向224.0.1.39发送announce报文，MA会监听224.0.1.39和224.0.1.40地址，仲裁出RP，然后通过224.0.1.40发送discovery报文，告知所有路由器RP的地址，所有路由器会监听该地址。
由于纯PIM-SM使用auto-RP时需要以组播方式发送announce报文，而发送的组播报文需要发送给RP，这使得纯PIM-SM模式下无法使用auto-RP模式，解决方案有：整网迁移使用sparse-dense-mode；或者所有路由器接口启用ip pim auto-rp listener，该命令可以在224.0.1.39和224.0.1.40组播组使用dense-mode。
默认情况下，静态RP的优先级会比auto-RP的优先级低。
3.  BSR
与auto-RP的用法类似，使用优先级来控制RP仲裁者BSRC来仲裁RP。
4.2.4   配置命令
ip pim rp-address x.x.x.x acl #在组播域内静态指定RP地址，acl参数表示指定组播组的RP
ip pim rp-address x.x.x.x override #使静态RP的优先级高于auto-rp
ip pim send-rp-announce lookback 1 scope 5 #在定义了PIM的某种模式的lookback 1接口发送announce报文，成为CRP
ip pim send-rp-discovery lookback 1 scope 5 #在定义了PIM的某种模式的lookback 1接口发送discovery报文，成为MA
show ip pim rp-mapping #查看RP
ip pim sparse-mode #端口开启PIM Sparse-mode
ip pim sparse-dense-mode #端口开启PIM Sparse-Dense-mode

ip pim spt-threshold traffic [infinity] #最后一跳路由器上设置切换阈值
4.2.5 DR的作用
在密集模式中，DR无用，稀疏模式中DR发送（*，G）join和（S，G）register报文。
